@using Microsoft.AspNetCore.Html
@using System.Text.Json
@model PublicationPage
@{
    ViewData["Title"] = Model.Title;
    ViewData["Description"] = Model.MetaDescription;
    ViewData["og:title"] = Model.Title;
    PublicationSection currentSection = ViewData["currentSection"] as PublicationSection;
}

<h2 class="article__title">Publication page - @Model.Title</h2>

@if (Model.PublicationSections is not null && Model.PublicationSections.Any())
{
    var sectionsToRender = currentSection is null
        ? Model.PublicationSections
        : Model.PublicationSections.Where(s => s.Slug == currentSection.Slug);

    foreach (PublicationSection publicationSection in sectionsToRender)
    {
        <h2>Publication section - @publicationSection.Title</h2>

        <partial name="PublicationSection" model="publicationSection" />
    }
}
else
{
    @foreach (JsonElement node in Model.Body.GetProperty("content").EnumerateArray())
    {
        object rendered = RichTextRenderer.Render(node);

        if (rendered is EmbeddedPartial partial)
        {
            <partial name="@partial.PartialName" model="@partial.Model" view-data='@(new ViewDataDictionary(ViewData) { { "AllowTwo", true } })' />
        }
        else if (rendered is string html)
        {
            @Html.Raw(html)
        }
    }
}